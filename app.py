import streamlit as st
import pandas as pd
import plotly.express as px
import io

# 1. å…§åµŒæ•¸æ“š (ç›´æ¥åŒ…å«æ‚¨çš„ Google èˆ‡ Meta å ±è¡¨è³‡æ–™)
csv_google_raw = """å»£å‘Šæ´»å‹•,å»£å‘Šç›®æ¨™,å»£å‘Šé¡å‹,å»£å‘ŠæœŸé–“(èµ·),å»£å‘ŠæœŸé–“(è¿„),è²»ç”¨,æ›å…‰æ¬¡æ•¸,é»æ“Šæ•¸,CPC,é»æ“Šç‡,è½‰æ›,è½‰æ›ç‡,å–®æ¬¡è½‰æ›è²»ç”¨,è½‰æ›é‡‘é¡,ROAS,é™„è¨»
251001_BOSCHæ‰“æ°£æ©Ÿ,BOSCHæ‰“æ°£æ©Ÿ,æœ€é«˜æˆæ•ˆ,2025/10/1,2025/10/7,NT$3,151,"52,935",767,NT$4.11,1.45%,0,0.00%,,NT$0,0.00
251007_LMè»Šç”¨é¦™æ°›,LMè»Šç”¨é¦™æ°›,é—œéµå­—å»£å‘Š,2025/10/1,2025/10/7,NT$0,9,0,NT$0.00,0.00%,0,0.00%,,NT$0,0.00
251001_BOSCHæ‰“æ°£æ©Ÿ,BOSCHæ‰“æ°£æ©Ÿ,æœ€é«˜æˆæ•ˆ,2025/10/8,2025/10/14,NT$2,005,"82,354",510,NT$3.93,0.62%,1,0.20%,NT$2,005,NT$2,005,1.00
251007_LMè»Šç”¨é¦™æ°›,LMè»Šç”¨é¦™æ°›,é—œéµå­—å»£å‘Š,2025/10/8,2025/10/14,NT$1,728,"11,332",124,NT$13.94,1.09%,0,0.00%,,,0.00
251001_BOSCHæ‰“æ°£æ©Ÿ,BOSCHæ‰“æ°£æ©Ÿ,æœ€é«˜æˆæ•ˆ,2025/10/15,2025/10/21,NT$1,524,"31,388",275,NT$5.54,0.88%,0,0.00%,,NT$0,0.00
251007_LMè»Šç”¨é¦™æ°›,LMè»Šç”¨é¦™æ°›,é—œéµå­—å»£å‘Š,2025/10/15,2025/10/21,NT$1,677,"2,278",90,NT$18.63,3.95%,1,1.11%,NT$1,677,NT$565,0.34
251001_BOSCHæ‰“æ°£æ©Ÿ,BOSCHæ‰“æ°£æ©Ÿ,æœ€é«˜æˆæ•ˆ,2025/10/22,2025/10/28,NT$1,962,"24,998",373,NT$5.26,1.49%,1,0.27%,NT$1,962,NT$2,290,1.17
251007_LMè»Šç”¨é¦™æ°›,LMè»Šç”¨é¦™æ°›,é—œéµå­—å»£å‘Š,2025/10/22,2025/10/28,NT$1,681,"1,644",89,NT$18.88,5.41%,0,0.00%,,NT$0,0.00
251001_BOSCHæ‰“æ°£æ©Ÿ,BOSCHæ‰“æ°£æ©Ÿ,æœ€é«˜æˆæ•ˆ,2025/10/29,2025/10/31,NT$584,"5,122",255,NT$2.29,4.98%,1,0.39%,NT$584,NT$2,055,3.52
251007_LMè»Šç”¨é¦™æ°›,LMè»Šç”¨é¦™æ°›,é—œéµå­—å»£å‘Š,2025/10/29,2025/10/31,NT$666,565,32,NT$20.83,5.66%,0,0.00%,,NT$0,0.00
251001_BOSCHæ‰“æ°£æ©Ÿ,BOSCHæ‰“æ°£æ©Ÿ,æœ€é«˜æˆæ•ˆ,2025/11/1,2025/11/9,NT$462,"4,459",715,NT$0.65,16.03%,0,0.00%,,,0.00
251007_LMè»Šç”¨é¦™æ°›,LMè»Šç”¨é¦™æ°›,é—œéµå­—å»£å‘Š,2025/11/1,2025/11/9,NT$482,536,24,NT$20.07,4.48%,0,0.00%,,,0.00
251001_1111å…é‹,å…¨ç«™,æœ€é«˜æˆæ•ˆ,2025/11/1,2025/11/9,NT$6,190,"87,740",4,269,NT$1.45,4.87%,1,0.02%,NT$6,190,NT$1,990,0.32
251001_1111å…é‹,å…¨ç«™,æœ€é«˜æˆæ•ˆ,2025/11/10,2025/11/11,NT$907,"7,724",545,NT$1.66,7.06%,0,0.00%,,,0.00
251001_BOSCHæ‰“æ°£æ©Ÿ,BOSCHæ‰“æ°£æ©Ÿ,æœ€é«˜æˆæ•ˆ,2025/11/12,2025/11/18,NT$1,167,"9,863",1,971,NT$0.59,19.98%,0,0.00%,,,0.00
251007_LMè»Šç”¨é¦™æ°›,LMè»Šç”¨é¦™æ°›,é—œéµå­—å»£å‘Š,2025/11/12,2025/11/18,NT$1,097,901,52,NT$21.10,5.77%,0,0.00%,,,0.00
251001_BOSCHæ‰“æ°£æ©Ÿ,BOSCHæ‰“æ°£æ©Ÿ,æœ€é«˜æˆæ•ˆ,2025/11/19,2025/12/3,NT$1,909,"21,303",280,NT$6.82,1.31%,2,0.71%,NT$955,NT$4,195,2.20
251007_LMè»Šç”¨é¦™æ°›,LMè»Šç”¨é¦™æ°›,é—œéµå­—å»£å‘Š,2025/11/19,2025/12/3,NT$2,852,"2,126",156,NT$18.28,7.34%,2,1.28%,NT$1,426,NT$630,0.22
251007_LMè»Šç”¨é¦™æ°›,LMè»Šç”¨é¦™æ°›,é—œéµå­—å»£å‘Š,2025/12/4,2025/12/4,NT$206,81,9,NT$22.89,11.11%,0,0.00%,,,0.00
251204_é›™12å…é‹,å…¨ç«™,æœ€é«˜æˆæ•ˆ,2025/12/4,2025/12/9,NT$3,614,"55,195",454,NT$7.96,0.82%,1,0.22%,NT$3,614,NT$1,990,0.55"""

csv_meta_raw = """å»£å‘Šæ´»å‹•,å»£å‘Šç›®æ¨™,å»£å‘ŠæœŸé–“(èµ·),å»£å‘ŠæœŸé–“(è¿„),è²»ç”¨,æ›å…‰æ¬¡æ•¸,é»æ“Šæ•¸,CPC,é»æ“Šç‡,è½‰æ›,è½‰æ›ç‡,å–®æ¬¡è½‰æ›è²»ç”¨,è½‰æ›é‡‘é¡,ROAS,é™„è¨»
BOSCHæ‰“æ°£æ©Ÿ,BOSCHæ‰“æ°£æ©Ÿ,2025/10/8,2025/10/14,NT$1,398,"27,490",1,198,NT$1.17,4.36%,0,0.00%,,,0.00
LMèŠ³é¦™ç£š,LMèŠ³é¦™ç£š,2025/10/7,2025/10/14,NT$1,434,"38,277",1,429,NT$1.00,3.73%,0,0.00%,,,0.00
BOSCHæ‰“æ°£æ©Ÿ,BOSCHæ‰“æ°£æ©Ÿ,2025/10/15,2025/10/21,NT$1,603,"15,849",362,NT$4.43,2.28%,6,1.66%,NT$267,NT$12,345,7.70
LMèŠ³é¦™ç£š,LMèŠ³é¦™ç£š,2025/10/15,2025/10/21,NT$1,524,"20,658",295,NT$5.17,1.43%,10,3.39%,NT$152,NT$6,430,4.22
BOSCHæ‰“æ°£æ©Ÿ,BOSCHæ‰“æ°£æ©Ÿ,2025/10/22,2025/10/28,NT$1,758,"17,374",447,NT$3.93,2.57%,2,0.45%,NT$879,NT$2,420,1.38
LMèŠ³é¦™ç£š,LMèŠ³é¦™ç£š,2025/10/22,2025/10/28,NT$1,752,"15,104",305,NT$5.74,2.02%,4,1.31%,NT$438,NT$2,260,1.29
BOSCHæ‰“æ°£æ©Ÿ,BOSCHæ‰“æ°£æ©Ÿ,2025/10/29,2025/10/31,NT$896,"10,654",158,NT$5.67,1.48%,0,0.00%,,,0.00
LMèŠ³é¦™ç£š,LMèŠ³é¦™ç£š,2025/10/29,2025/10/31,NT$892,"11,968",132,NT$6.76,1.10%,4,3.03%,NT$223,NT$2,010,2.25
251101_1111å…é‹,å…¨ç«™,2025/11/1,2025/11/9,NT$7,184,"55,497",1,471,NT$4.88,2.65%,5,0.34%,NT$1,437,NT$8,665,1.21
251101_1111å…é‹-å‰¯æœ¬,å…¨ç«™,2025/11/1,2025/11/9,NT$1,522,"13,334",429,NT$3.55,3.22%,4,0.93%,NT$381,NT$5,254,3.45
251101_1111å…é‹-å‰¯æœ¬,å…¨ç«™,2025/11/10,2025/11/11,NT$2,929,"14,450",696,NT$4.21,4.82%,8,1.15%,NT$366,NT$7,515,2.57
251014_BOSCHæ‰“æ°£æ©Ÿ,BOSCHæ‰“æ°£æ©Ÿ,2025/11/12,2025/11/18,NT$2,423,"41,389",532,NT$4.55,1.29%,5,0.94%,NT$485,NT$9,284,3.83
251014_LMèŠ³é¦™ç£š,LMèŠ³é¦™ç£š,2025/11/12,2025/11/18,NT$2,354,"30,336",383,NT$6.15,1.26%,12,3.13%,NT$196,NT$9,275,3.94
251014_BOSCHæ‰“æ°£æ©Ÿ,BOSCHæ‰“æ°£æ©Ÿ,2025/11/19,2025/12/3,NT$4,568,"52,364",610,NT$7.49,1.16%,7,1.15%,NT$653,NT$11,905,2.61
251113_LMèŠ³é¦™ç£š,LMèŠ³é¦™ç£š,2025/11/19,2025/12/3,NT$5,934,"82,282",954,NT$6.22,1.16%,24,2.52%,NT$247,NT$15,050,2.54
251113_LMèŠ³é¦™ç£š,LMèŠ³é¦™ç£š,2025/12/4,2025/12/4,NT$260,"2,874",35,NT$7.43,1.22%,0,0.00%,,,0.00
251204_é›™12å…é‹,å…¨ç«™,2025/12/4,2025/12/9,NT$7,760,"81,843",2,040,NT$3.80,2.49%,23,1.13%,NT$337,NT$3,312,0.43"""

# 2. è¨­å®šé é¢
st.set_page_config(page_title="å»£å‘Šæˆæ•ˆå„€è¡¨æ¿", layout="wide")
st.title("ğŸ“Š Google & Meta å»£å‘Šæˆæ•ˆé›²ç«¯æˆ°æƒ…å®¤")

# 3. è™•ç†æ•¸æ“šå‡½æ•¸
@st.cache_data
def load_and_clean_data():
    df_g = pd.read_csv(io.StringIO(csv_google_raw))
    df_m = pd.read_csv(io.StringIO(csv_meta_raw))
    
    df_g['Platform'] = 'Google'
    df_m['Platform'] = 'Meta'
    
    # æ¸…ç†é‚è¼¯
    def clean_currency(x):
        if isinstance(x, str): return float(x.replace('NT$', '').replace(',', '').strip())
        return x
    
    cols_currency = ['è²»ç”¨', 'CPC', 'å–®æ¬¡è½‰æ›è²»ç”¨', 'è½‰æ›é‡‘é¡']
    cols_num = ['æ›å…‰æ¬¡æ•¸', 'é»æ“Šæ•¸', 'è½‰æ›']
    
    for df in [df_g, df_m]:
        for col in cols_currency:
            if col in df.columns: df[col] = df[col].apply(clean_currency)
        for col in cols_num:
             if col in df.columns: df[col] = df[col].apply(lambda x: float(str(x).replace(',', '')))
        
        # æ—¥æœŸè½‰æ› (ç¢ºä¿æ ¼å¼ä¸€è‡´)
        df['å»£å‘ŠæœŸé–“(èµ·)'] = pd.to_datetime(df['å»£å‘ŠæœŸé–“(èµ·)'], errors='coerce')
        if 'è½‰æ›é‡‘é¡' in df.columns: df['è½‰æ›é‡‘é¡'] = df['è½‰æ›é‡‘é¡'].fillna(0)
        if 'ROAS' in df.columns: df['ROAS'] = df['ROAS'].fillna(0)

    # åˆä½µ
    common = ['Platform', 'å»£å‘Šæ´»å‹•', 'å»£å‘ŠæœŸé–“(èµ·)', 'è²»ç”¨', 'æ›å…‰æ¬¡æ•¸', 'é»æ“Šæ•¸', 'CPC', 'è½‰æ›', 'è½‰æ›é‡‘é¡', 'ROAS']
    return pd.concat([df_g[common], df_m[common]], ignore_index=True)

df = load_and_clean_data()

# 4. å´é‚Šæ¬„æ§åˆ¶èˆ‡éæ¿¾
st.sidebar.header("ğŸ¯ åˆ†æéæ¿¾å™¨")
platforms = st.sidebar.multiselect("é¸æ“‡å¹³å°", df['Platform'].unique(), default=df['Platform'].unique())
campaigns = st.sidebar.multiselect("é¸æ“‡å»£å‘Šæ´»å‹•", df['å»£å‘Šæ´»å‹•'].unique(), default=df['å»£å‘Šæ´»å‹•'].unique())

min_date, max_date = df['å»£å‘ŠæœŸé–“(èµ·)'].min(), df['å»£å‘ŠæœŸé–“(èµ·)'].max()
date_range = st.sidebar.date_input("é¸æ“‡æ—¥æœŸå€é–“", [min_date, max_date])

# æ‡‰ç”¨éæ¿¾
if len(date_range) == 2:
    start_d, end_d = pd.to_datetime(date_range[0]), pd.to_datetime(date_range[1])
    mask = (df['Platform'].isin(platforms)) & (df['å»£å‘Šæ´»å‹•'].isin(campaigns)) & (df['å»£å‘ŠæœŸé–“(èµ·)'] >= start_d) & (df['å»£å‘ŠæœŸé–“(èµ·)'] <= end_d)
    df_filtered = df[mask]
else:
    df_filtered = df

# 5. æ ¸å¿ƒæŒ‡æ¨™ (KPIs)
col1, col2, col3, col4 = st.columns(4)
total_cost = df_filtered['è²»ç”¨'].sum()
total_rev = df_filtered['è½‰æ›é‡‘é¡'].sum()
avg_roas = total_rev / total_cost if total_cost > 0 else 0
total_clicks = df_filtered['é»æ“Šæ•¸'].sum()

col1.metric("ğŸ’° ç¸½èŠ±è²» (Cost)", f"${total_cost:,.0f}")
col2.metric("ğŸ’µ ç¸½ç‡Ÿæ”¶ (Revenue)", f"${total_rev:,.0f}")
col3.metric("ğŸ“ˆ æ•´é«” ROAS", f"{avg_roas:.2f}")
col4.metric("ğŸ‘† ç¸½é»æ“Šæ•¸", f"{total_clicks:,.0f}")

st.divider()

# 6. å¯è¦–åŒ–åœ–è¡¨
c1, c2 = st.columns([2, 1])

with c1:
    st.subheader("ğŸ“… é›™å¹³å°è¶¨å‹¢åˆ†æ (Weekly Trend)")
    # æ ¹æ“šé€±æ¬¡èšåˆæ•¸æ“š
    df_filtered['Week'] = df_filtered['å»£å‘ŠæœŸé–“(èµ·)'].dt.to_period('W').apply(lambda r: r.start_time)
    df_weekly = df_filtered.groupby(['Platform', 'Week'])[['è²»ç”¨', 'è½‰æ›é‡‘é¡', 'ROAS']].mean().reset_index()
    
    metric_select = st.selectbox("é¸æ“‡è¶¨å‹¢æŒ‡æ¨™", ['ROAS', 'è²»ç”¨', 'è½‰æ›é‡‘é¡'], index=0)
    fig_line = px.line(df_weekly, x='Week', y=metric_select, color='Platform', markers=True, title=f"{metric_select} é€±èµ°å‹¢")
    st.plotly_chart(fig_line, use_container_width=True)

with c2:
    st.subheader("ğŸ“Š å»£å‘Šæ•ˆç›Šæ•£ä½ˆåœ–")
    # æ¯å€‹å»£å‘Šæ´»å‹•çš„è¡¨ç¾
    df_agg = df_filtered.groupby(['Platform', 'å»£å‘Šæ´»å‹•'])[['è²»ç”¨', 'è½‰æ›é‡‘é¡', 'ROAS']].sum().reset_index()
    fig_scat = px.scatter(df_agg, x='è²»ç”¨', y='è½‰æ›é‡‘é¡', color='Platform', size='ROAS', hover_name='å»£å‘Šæ´»å‹•', 
                          title="èŠ±è²» vs ç‡Ÿæ”¶ (é»è¶Šå¤§ ROAS è¶Šé«˜)")
    st.plotly_chart(fig_scat, use_container_width=True)

with st.expander("ğŸ“„ æŸ¥çœ‹è©³ç´°æ•¸æ“šå ±è¡¨"):
    st.dataframe(df_filtered.sort_values(by='å»£å‘ŠæœŸé–“(èµ·)', ascending=False))